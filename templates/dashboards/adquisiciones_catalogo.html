<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Adquisiciones y Cat√°logo </title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Carga la librer√≠a de Google Charts -->
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <style>
        /* Estilos del dise√±o oscuro original */
        body { background-color: #1a1a2e; color: #e4e4e4; font-family: 'Inter', sans-serif; }
        .chart-container { 
            background-color: #24243e; 
            border-radius: 12px; 
            padding: 25px; 
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.4); 
            margin-bottom: 30px; 
            /* Asegura que los gr√°ficos de Google Chart hereden el color de fondo */
            display: flex;
            flex-direction: column;
        }
        h1 { color: #ffcc00; text-align: center; font-size: 2.5rem; margin-bottom: 20px; }
        .filter-control { 
            background-color: #000; 
            padding: 15px; 
            border-radius: 8px; 
            margin-bottom: 30px; 
            display: flex; 
            gap: 20px; 
            flex-wrap: wrap; 
            justify-content: center; 
            align-items: center; 
        }
        .filter-control label, .filter-control select { color: #ffd700; font-weight: 600; }
        .filter-control input, .filter-control select { 
            background-color: #333; 
            color: #fff; 
            border: 1px solid #555; 
            padding: 8px 12px; 
            border-radius: 6px; 
            cursor: pointer; 
        }
        /* Ajuste de altura para los contenedores de Google Charts */
        .google-chart { height: 400px; }
    </style>
</head>
<body class="p-8">

    <h1 class="text-3xl font-bold">üõí Adquisiciones, Proveedores y Cat√°logo Vivo</h1>

    <!-- Controles de Filtro -->
    <div class="filter-control">
        <label for="filter-anio">A√±o:</label>
        <input type="number" id="filter-anio" placeholder="Ej: 2024" onchange="fetchAndDrawAllCharts()">
        
        <label for="filter-proveedor">Proveedor:</label>
        <input type="text" id="filter-proveedor" placeholder="Ej: Libros SA" onchange="fetchAndDrawAllCharts()">
        
        <label for="filter-categoria">Categor√≠a:</label>
        <input type="text" id="filter-categoria" placeholder="Ej: Ficci√≥n" onchange="fetchAndDrawAllCharts()">
        
        <label for="filter-fin">Fecha de Pedido (Fin):</label>
        <input type="date" id="filter-fin" onchange="fetchAndDrawAllCharts()">
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
        <!-- Gr√°fico 1: TreeMap -->
        <div class="chart-container lg:col-span-1">
            <h2 class="text-xl font-semibold mb-4 text-white">Volumen de Materiales por Categor√≠a Tem√°tica (TreeMap)</h2>
            <div id="treemap_chart" class="google-chart"></div>
        </div>

        <!-- Gr√°fico 2: Bar Chart (Reemplazo de Sankey) -->
        <div class="chart-container lg:col-span-1">
            <h2 class="text-xl font-semibold mb-4 text-white">Volumen de Adquisici√≥n por Proveedor y Material</h2>
            <div id="sankey_chart" class="google-chart"></div>
        </div>

        <!-- Gr√°fico 3: Bubble Chart -->
        <div class="chart-container lg:col-span-2">
            <h2 class="text-xl font-semibold mb-4 text-white">Costo Promedio vs. Volumen por Tipo de Material (Simulaci√≥n)</h2>
            <div id="bubble_chart" class="google-chart"></div>
        </div>
    </div>

    <script>
        // Carga el paquete de Google Charts.
        google.charts.load('current', {'packages':['corechart', 'treemap']});
        google.charts.setOnLoadCallback(fetchAndDrawAllCharts);

        const BASE_API_URL = '/api/data/';

        // Colores y Estilos para Gr√°ficos Oscuros
        const darkThemeOptions = {
            backgroundColor: 'transparent',
            titleTextStyle: { color: '#e4e4e4', fontSize: 18 },
            legend: { textStyle: { color: '#ffd700' } },
            hAxis: {
                textStyle: { color: '#e4e4e4' },
                titleTextStyle: { color: '#e4e4e4' },
                gridlines: { color: '#333' }
            },
            vAxis: {
                textStyle: { color: '#e4e4e4' },
                titleTextStyle: { color: '#e4e4e4' },
                gridlines: { color: '#333' }
            },
            chartArea: {
                backgroundColor: 'transparent',
                left: 80, 
                top: 50, 
                width: '85%', 
                height: '75%'
            },
            tooltip: { textStyle: { color: '#000' } }
        };

        // --- FUNCIONES DE DIBUJO DE GOOGLE CHARTS ---

        /**
         * 1. Dibuja el TreeMap para Categor√≠as de Materiales.
         * Basado en: vw_categorias_materiales
         */
        function drawTreeMapChart(rawData, elementId, title) {
            const container = document.getElementById(elementId);
            container.innerHTML = ''; 

            if (!rawData || rawData.length === 0) {
                container.innerHTML = '<p class="text-center text-red-400 mt-20">No hay datos para el TreeMap.</p>';
                return;
            }

            const dataTable = new google.visualization.DataTable();
            dataTable.addColumn('string', 'Categor√≠a');
            dataTable.addColumn('string', 'Parent');
            dataTable.addColumn('number', 'Total T√≠tulos');
            dataTable.addColumn('number', 'Color'); // Usado para el color de la celda

            // 1. A√±adir el nodo ra√≠z
            dataTable.addRow(['Cat√°logo General', null, 0, 0]);

            // 2. A√±adir los nodos de categor√≠as
            rawData.forEach(d => {
                // [Nombre, Padre, Valor, Color (usamos el valor para el color)]
                dataTable.addRow([d.categoria, 'Cat√°logo General', d.total_titulos, d.total_titulos]);
            });
            
            const options = {
                ...darkThemeOptions,
                maxColor: '#ffcc00', 
                midColor: '#5c6495', 
                minColor: '#24243e',
                headerHeight: 20,
                showScale: true,
                fontSize: 16,
                generateTooltip: function(row, size, value) {
                    return `<div style="padding:10px; font-size:14px; background:white; color:black;">
                                <b>${dataTable.getValue(row, 0)}</b><br>
                                T√≠tulos: ${dataTable.getValue(row, 2).toLocaleString()}
                            </div>`;
                }
            };

            const chart = new google.visualization.TreeMap(container);
            chart.draw(dataTable, options);
        }

        /**
         * 2. Dibuja el Gr√°fico de Barras Agrupadas (Reemplazo de Sankey).
         * Basado en: vw_flujo_proveedor_catalogo
         */
        function drawBarChart(rawData, elementId, title) {
            const container = document.getElementById(elementId);
            container.innerHTML = ''; 

            if (!rawData || rawData.length === 0) {
                container.innerHTML = '<p class="text-center text-red-400 mt-20">No hay datos de flujo Proveedor-Material.</p>';
                return;
            }

            // Mapeo y agregaci√≥n de datos (Simulando la vista por material: Libro, Revista, Otro)
            const aggregated = {};
            rawData.forEach(d => {
                let materialType = 'Otro';
                if (d.recurso.toLowerCase().includes('libro')) materialType = 'Libro';
                else if (d.recurso.toLowerCase().includes('dvd') || d.recurso.toLowerCase().includes('audio')) materialType = 'Audiovisual';
                else if (d.recurso.toLowerCase().includes('revista') || d.recurso.toLowerCase().includes('journal')) materialType = 'Revista';

                if (!aggregated[d.proveedor]) {
                    aggregated[d.proveedor] = { 'Libro': 0, 'Audiovisual': 0, 'Revista': 0, 'Otro': 0 };
                }
                aggregated[d.proveedor][materialType] += d.cantidad;
            });

            // Creaci√≥n de la DataTable
            const dataTable = new google.visualization.DataTable();
            dataTable.addColumn('string', 'Proveedor');
            dataTable.addColumn('number', 'Libro');
            dataTable.addColumn('number', 'Audiovisual');
            dataTable.addColumn('number', 'Revista');
            dataTable.addColumn('number', 'Otro');

            Object.keys(aggregated).forEach(proveedor => {
                const data = aggregated[proveedor];
                dataTable.addRow([
                    proveedor,
                    data.Libro,
                    data.Audiovisual,
                    data.Revista,
                    data.Otro
                ]);
            });

            const options = {
                ...darkThemeOptions,
                isStacked: true,
                series: {
                    0: { color: '#ffcc00' }, // Amarillo
                    1: { color: '#3b82f6' }, // Azul
                    2: { color: '#10b981' }, // Verde
                    3: { color: '#a8a8a8' }, // Gris
                },
                legend: { position: 'top', alignment: 'center', textStyle: darkThemeOptions.legend.textStyle },
                bar: { groupWidth: '85%' },
                orientation: 'vertical'
            };

            const chart = new google.visualization.ColumnChart(container); // Usamos ColumnChart (barras verticales)
            chart.draw(dataTable, options);
        }

        /**
         * 3. Dibuja el Bubble Chart.
         * Basado en: Simulaci√≥n de datos de Costo vs. Volumen
         */
        function drawBubbleChart(rawData, elementId, title) {
            const container = document.getElementById(elementId);
            container.innerHTML = ''; 

            // Datos Simulados: [Tipo, Costo Promedio (X), Cantidad Total (Y), Categor√≠a (Color), Volumen (Tama√±o)]
            const simulatedData = [
                ['Tipo de Material', 'Costo Promedio (MXN)', 'Volumen Total Adquirido', 'Categor√≠a', 'Volumen Total Adquirido'],
                ['Libros (F√≠sico)', 55, 1500, 'Libro', 1500],
                ['Audiovisual (DVD/Blu-ray)', 85, 500, 'DVD/Audio', 500],
                ['Revistas/Journals', 20, 2000, 'Peri√≥dicos', 2000],
                ['Libros (Digital)', 30, 800, 'eBook', 800],
                ['Mapas/Cartograf√≠a', 12, 150, 'Otros', 150]
            ];

            const dataTable = google.visualization.arrayToDataTable(simulatedData);
            
            const options = {
                ...darkThemeOptions,
                colorAxis: { colors: ['#ffcc00', '#10b981', '#3b82f6', '#ef4444'] },
                bubble: { textStyle: { color: '#000', fontName: 'Inter', fontSize: 11 } },
                hAxis: { title: 'Costo Promedio Unitario (MXN)', ...darkThemeOptions.hAxis },
                vAxis: { title: 'Volumen Total Adquirido (Unidades)', ...darkThemeOptions.vAxis },
                sizeAxis: { minValue: 0, maxSize: 15 },
            };

            const chart = new google.visualization.BubbleChart(container);
            chart.draw(dataTable, options);
            
            // Mensaje de nota para los datos simulados
            container.insertAdjacentHTML('beforeend', '<p class="text-xs text-gray-400 mt-2">Nota: Este gr√°fico utiliza datos de costo y volumen simulados, ya que la consulta SQL proporcionada no contiene la m√©trica de costo.</p>');
        }

        // --- L√ìGICA DE DATOS Y FILTROS ---

        // Simulaci√≥n de Fetch (En un entorno real, descomentar√≠as el fetch y eliminar√≠as la dataSimulada)
        function fetchDataAndDraw(queryName, drawFunction, elementId, title, filters) {
            // En un entorno real, usar√≠as: const url = `${BASE_API_URL}${queryName}?${filters}`;
            // Y luego fetch(url)...

            // --- SIMULACI√ìN DE DATOS LOCALES ---
            const simulatedData = {
                'categorias_materiales': [
                    { categoria: 'Agronomia', total_titulos: 1500 },
                    { categoria: 'Ecologia', total_titulos: 2500 },
                    { categoria: 'Agricultura', total_titulos: 1800 },
                    { categoria: 'Fauna', total_titulos: 700 },
                    { categoria: 'Revistas Cient√≠ficas', total_titulos: 900 }
                ],
                'flujo_proveedor_catalogo': [
                    { proveedor: 'Editorial Siglo XXI', recurso: 'Libro A', cantidad: 120 },
                    { proveedor: 'Editorial Siglo XXI', recurso: 'Revista B', cantidad: 300 },
                    { proveedor: 'Distribuidora Global', recurso: 'DVD C', cantidad: 80 },
                    { proveedor: 'Distribuidora Global', recurso: 'Libro D', cantidad: 200 },
                    { proveedor: 'Imprenta Local', recurso: 'Libro E', cantidad: 50 },
                    { proveedor: 'Editorial Siglo XXI', recurso: 'Libro F', cantidad: 150 },
                    { proveedor: 'Distribuidora Global', recurso: 'Audiovisual G', cantidad: 40 },
                ],
                // El bubble chart usa datos hardcodeados directamente en su funci√≥n de dibujo.
                'catalogo_incorporaciones': [{dummy: true}] 
            };
            // --- FIN SIMULACI√ìN ---
            
            // Placeholder visual mientras se dibuja
            document.getElementById(elementId).innerHTML = `<p class="text-center text-blue-400 mt-20">Cargando gr√°fico de ${title}...</p>`;

            const data = simulatedData[queryName];
            
            if (data && data.length > 0) {
                drawFunction(data, elementId, title);
            } else {
                document.getElementById(elementId).innerHTML = `<p class="text-center text-red-400 mt-20">üö® No hay datos disponibles para ${title} con los filtros seleccionados.</p>`;
            }

            /* // C√ìDIGO REAL PARA CONECTAR A LA API (Descomentar en producci√≥n)
            
            fetch(url)
                .then(response => {
                    if (!response.ok) throw new Error(`Error en la API: ${response.status}`);
                    return response.json();
                })
                .then(data => {
                    if (data && data.length > 0) {
                        drawFunction(data, elementId, title);
                    } else {
                        document.getElementById(elementId).innerHTML = `<p class="text-center text-red-400 mt-20">üö® No hay datos disponibles para ${title} con los filtros seleccionados.</p>`;
                    }
                })
                .catch(error => {
                    console.error(`Error fetching data for ${queryName}:`, error);
                    document.getElementById(elementId).innerHTML = `<p class="text-center text-red-400 mt-20">‚ùå Error al conectar con la base de datos para ${title}.</p>`;
                });
            */
        }

        function fetchAndDrawAllCharts() {
            // Los filtros son recolectados, pero solo son utilizados por el fetch real (no por la simulaci√≥n local)
            const anio = document.getElementById('filter-anio').value;
            const proveedor = document.getElementById('filter-proveedor').value;
            const categoria = document.getElementById('filter-categoria').value;
            const fecha_fin = document.getElementById('filter-fin').value; 
            
            const filters = `anio=${anio}&proveedor=${proveedor}&categoria=${categoria}&fecha_fin=${fecha_fin}&fecha_inicio=1970-01-01`;
            
            // Gr√°fico 1: TreeMap (Categor√≠as de Materiales)
            fetchDataAndDraw(
                'categorias_materiales', 
                drawTreeMapChart, 
                'treemap_chart', 
                'Volumen de Materiales por Categor√≠a Tem√°tica',
                filters
            );

            // Gr√°fico 2: Bar Chart (Reemplazo de Sankey - Flujo Proveedor)
            fetchDataAndDraw(
                'flujo_proveedor_catalogo', 
                drawBarChart, 
                'sankey_chart', 
                'Volumen de Adquisici√≥n por Proveedor y Material',
                filters
            );
            
            // Gr√°fico 3: Bubble Chart (Costo promedio, usa data simulada)
            fetchDataAndDraw(
                'catalogo_incorporaciones', // Usamos esta query como dummy, la funci√≥n usa datos internos
                drawBubbleChart, 
                'bubble_chart', 
                'Costo Promedio por Tipo de Material',
                filters
            );
        }
        
        // La funci√≥n fetchAndDrawAllCharts se llama autom√°ticamente cuando Google Charts est√° listo (google.charts.setOnLoadCallback)
    </script>
</body>
</html>