<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Impacto y Uso Acad√©mico</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <style>
        body {
            background-color: #1a1a2e; /* Fondo oscuro */
            color: #e4e4e4;
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 20px;
        }
        .chart-container {
            background-color: #24243e;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.4);
            margin-bottom: 30px;
        }
        h1 {
            color: #ffcc00; /* Dorado para el t√≠tulo principal */
            text-align: center;
            margin-bottom: 20px;
            font-size: 2.5rem;
        }
        .filter-control {
            background-color: #000;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 30px;
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            justify-content: center;
            align-items: center;
        }
        .filter-control label {
            color: #ffd700;
            font-weight: 600;
        }
        .filter-control input[type="date"] {
            background-color: #333;
            color: #fff;
            border: 1px solid #555;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
        }
    </style>
</head>
<body>

    <h1 class="text-3xl font-bold">üìö Impacto y Uso Acad√©mico</h1>

    <!-- Controles de Filtro de Rango de Fecha -->
    <div class="filter-control">
        <label for="filter-inicio">Fecha de Inicio:</label>
        <input type="date" id="filter-inicio" onchange="fetchAndDrawAllCharts()">
        
        <label for="filter-fin">Fecha de Fin:</label>
        <input type="date" id="filter-fin" onchange="fetchAndDrawAllCharts()">
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
        <!-- Gr√°fico 1: Pr√©stamos por Departamento (Column Chart) -->
        <div class="chart-container">
            <h2 class="text-xl font-semibold mb-4 text-white">Pr√©stamos por Departamento/Carrera</h2>
            <div id="column_chart_departamento" class="h-96"></div>
        </div>

        <!-- Gr√°fico 2: Frecuencia de pr√©stamo por d√≠a de la semana (Line Chart) -->
        <div class="chart-container">
            <h2 class="text-xl font-semibold mb-4 text-white">Frecuencia de Pr√©stamo por D√≠a de la Semana</h2>
            <div id="line_chart_frecuencia" class="h-96"></div>
        </div>

        <!-- Gr√°fico 3: Proporci√≥n Libros vs Audiovisuales (Pie Chart) -->
        <div class="chart-container md:col-span-2">
            <h2 class="text-xl font-semibold mb-4 text-white">Proporci√≥n de Material Prestado (Libros vs Audiovisuales)</h2>
            <div id="pie_chart_proporcion" class="h-96"></div>
        </div>
    </div>

    <script type="text/javascript">
        // Google Charts
        google.charts.load('current', {'packages':['corechart', 'bar']});
        google.charts.setOnLoadCallback(fetchAndDrawAllCharts);

        const BASE_API_URL = '/api/data/';

        // --- FUNCIONES DE DIBUJO ---

        // Funci√≥n de Dibujo para Gr√°fico de Columna/Barras
        function drawColumnChart(data, elementId, title) {
            const dataTable = new google.visualization.DataTable();
            dataTable.addColumn('string', 'Departamento');
            dataTable.addColumn('number', 'Total Pr√©stamos');
            
            const rows = data.map(row => [row.nombre, row.total_prestamos]);
            dataTable.addRows(rows);

            const options = {
                title: title,
                backgroundColor: 'transparent',
                legend: { position: 'none' },
                hAxis: { title: 'Departamento', textStyle: { color: '#e4e4e4' } },
                vAxis: { title: 'Total Pr√©stamos', textStyle: { color: '#e4e4e4' }, gridlines: { color: '#333' } },
                colors: ['#3e9dff'],
                titleTextStyle: { color: '#fff' }
            };

            const chart = new google.visualization.ColumnChart(document.getElementById(elementId));
            chart.draw(dataTable, options);
        }

        // Funci√≥n de Dibujo para Gr√°fico de L√≠nea
        function drawLineChart(data, elementId, title) {
            const dataTable = new google.visualization.DataTable();
            dataTable.addColumn('string', 'D√≠a');
            dataTable.addColumn('number', 'Pr√©stamos');
            
            // Mapeo para ordenar d√≠as de la semana (asumiendo que vienen en espa√±ol)
            const order = ['Lunes', 'Martes', 'Mi√©rcoles', 'Jueves', 'Viernes', 'S√°bado', 'Domingo'];
            const sortedData = data.sort((a, b) => order.indexOf(a.dia_semana) - order.indexOf(b.dia_semana));

            const rows = sortedData.map(row => [row.dia_semana, row.prestamos]);
            dataTable.addRows(rows);

            const options = {
                title: title,
                backgroundColor: 'transparent',
                curveType: 'function',
                legend: { position: 'bottom', textStyle: { color: '#e4e4e4' } },
                hAxis: { textStyle: { color: '#e4e4e4' } },
                vAxis: { title: 'Pr√©stamos', textStyle: { color: '#e4e4e4' }, gridlines: { color: '#333' } },
                series: { 0: { color: '#ffcc00' } },
                titleTextStyle: { color: '#fff' }
            };

            const chart = new google.visualization.LineChart(document.getElementById(elementId));
            chart.draw(dataTable, options);
        }
        
        // Funci√≥n de Dibujo para Gr√°fico de Tarta
        function drawPieChart(data, elementId, title) {
            const dataTable = new google.visualization.DataTable();
            dataTable.addColumn('string', 'Tipo de Material');
            dataTable.addColumn('number', 'Cantidad');
            
            const rows = data.map(row => [row.tipo_material, row.cantidad_prestamos]);
            dataTable.addRows(rows);

            const options = {
                title: title,
                backgroundColor: 'transparent',
                is3D: true,
                titleTextStyle: { color: '#fff' },
                legend: { textStyle: { color: '#e4e4e4' } },
                pieSliceText: 'percentage',
                colors: ['#4caf50', '#ff9800'] // Verde y Naranja
            };

            const chart = new google.visualization.PieChart(document.getElementById(elementId));
            chart.draw(dataTable, options);
        }

        // --- L√ìGICA DE DATOS Y FILTROS ---

        function fetchAndDrawAllCharts() {
            // ‚¨áÔ∏è 1. Capturar los valores de los filtros de fecha
            const fecha_inicio = document.getElementById('filter-inicio').value;
            const fecha_fin = document.getElementById('filter-fin').value;

            const filters = `fecha_inicio=${fecha_inicio}&fecha_fin=${fecha_fin}`;
            
            // Gr√°fico 1: Column Chart (Pr√©stamos por Departamento)
            fetchDataAndDraw(
                'prestamos_por_departamento', 
                drawColumnChart, 
                'column_chart_departamento', 
                'Pr√©stamos por Departamento/Carrera',
                filters
            );

            // Gr√°fico 2: Line Chart (Frecuencia por d√≠a de la semana)
            fetchDataAndDraw(
                'frecuencia_prestamos', 
                drawLineChart, 
                'line_chart_frecuencia', 
                'Frecuencia de Pr√©stamo por D√≠a de la Semana',
                filters
            );

            // Gr√°fico 3: Pie Chart (Proporci√≥n Libros vs Audiovisuales)
            // NOTA: Este gr√°fico no usa filtros de fecha por la naturaleza de la query original, 
            // pero enviamos los filtros al backend que ya sabe c√≥mo ignorarlos.
            fetchDataAndDraw(
                'proporcion_material', 
                drawPieChart, 
                'pie_chart_proporcion', 
                'Proporci√≥n de Material Prestado',
                filters
            );
        }

        function fetchDataAndDraw(queryName, drawFunction, elementId, title, filters) {
            const url = `${BASE_API_URL}${queryName}?${filters}`;
            
            fetch(url)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`Error en la API: ${response.statusText}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data && data.length > 0) {
                        drawFunction(data, elementId, title);
                    } else {
                        document.getElementById(elementId).innerHTML = `<p class="text-red-400">üö® No hay datos disponibles para ${title} con los filtros seleccionados.</p>`;
                    }
                })
                .catch(error => {
                    console.error(`Error fetching data for ${queryName}:`, error);
                    document.getElementById(elementId).innerHTML = `<p class="text-red-400">‚ùå Error al conectar con la base de datos para ${title}. Detalles: ${error.message}</p>`;
                });
        }
    </script>
</body>
</html>